{"version":3,"file":"autoInstrumentMiddleware.js","sources":["../../../src/vite/autoInstrumentMiddleware.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\ntype AutoInstrumentMiddlewareOptions = {\n  enabled?: boolean;\n  debug?: boolean;\n};\n\ntype WrapResult = {\n  code: string;\n  didWrap: boolean;\n  skipped: string[];\n};\n\n/**\n * Core function that wraps middleware arrays matching the given regex.\n */\nfunction wrapMiddlewareArrays(code: string, id: string, debug: boolean, regex: RegExp): WrapResult {\n  const skipped: string[] = [];\n  let didWrap = false;\n\n  const transformed = code.replace(regex, (match: string, key: string, contents: string) => {\n    const objContents = arrayToObjectShorthand(contents);\n    if (objContents) {\n      didWrap = true;\n      if (debug) {\n        // eslint-disable-next-line no-console\n        console.log(`[Sentry] Auto-wrapping ${key} in ${id}`);\n      }\n      return `${key}: wrapMiddlewaresWithSentry(${objContents})`;\n    }\n    // Track middlewares that couldn't be auto-wrapped\n    // Skip if we matched whitespace only\n    if (contents.trim()) {\n      skipped.push(key);\n    }\n    return match;\n  });\n\n  return { code: transformed, didWrap, skipped };\n}\n\n/**\n * Wraps global middleware arrays (requestMiddleware, functionMiddleware) in createStart() files.\n */\nexport function wrapGlobalMiddleware(code: string, id: string, debug: boolean): WrapResult {\n  return wrapMiddlewareArrays(code, id, debug, /(requestMiddleware|functionMiddleware)\\s*:\\s*\\[([^\\]]*)\\]/g);\n}\n\n/**\n * Wraps route middleware arrays in createFileRoute() files.\n */\nexport function wrapRouteMiddleware(code: string, id: string, debug: boolean): WrapResult {\n  return wrapMiddlewareArrays(code, id, debug, /(middleware)\\s*:\\s*\\[([^\\]]*)\\]/g);\n}\n\n/**\n * A Vite plugin that automatically instruments TanStack Start middlewares:\n * - `requestMiddleware` and `functionMiddleware` arrays in `createStart()`\n * - `middleware` arrays in `createFileRoute()` route definitions\n */\nexport function makeAutoInstrumentMiddlewarePlugin(options: AutoInstrumentMiddlewareOptions = {}): Plugin {\n  const { enabled = true, debug = false } = options;\n\n  return {\n    name: 'sentry-tanstack-middleware-auto-instrument',\n    enforce: 'pre',\n\n    transform(code, id) {\n      if (!enabled) {\n        return null;\n      }\n\n      // Skip if not a TS/JS file\n      if (!/\\.(ts|tsx|js|jsx|mjs|mts)$/.test(id)) {\n        return null;\n      }\n\n      // Detect file types that should be instrumented\n      const isStartFile = id.includes('start') && code.includes('createStart(');\n      const isRouteFile = code.includes('createFileRoute(') && /middleware\\s*:\\s*\\[/.test(code);\n\n      if (!isStartFile && !isRouteFile) {\n        return null;\n      }\n\n      // Skip if the user already did some manual wrapping\n      if (code.includes('wrapMiddlewaresWithSentry')) {\n        return null;\n      }\n\n      let transformed = code;\n      let needsImport = false;\n      const skippedMiddlewares: string[] = [];\n\n      switch (true) {\n        // global middleware\n        case isStartFile: {\n          const result = wrapGlobalMiddleware(transformed, id, debug);\n          transformed = result.code;\n          needsImport = needsImport || result.didWrap;\n          skippedMiddlewares.push(...result.skipped);\n          break;\n        }\n        // route middleware\n        case isRouteFile: {\n          const result = wrapRouteMiddleware(transformed, id, debug);\n          transformed = result.code;\n          needsImport = needsImport || result.didWrap;\n          skippedMiddlewares.push(...result.skipped);\n          break;\n        }\n        default:\n          break;\n      }\n\n      // Warn about middlewares that couldn't be auto-wrapped\n      if (skippedMiddlewares.length > 0) {\n        // eslint-disable-next-line no-console\n        console.warn(\n          `[Sentry] Could not auto-instrument ${skippedMiddlewares.join(' and ')} in ${id}. ` +\n            'To instrument these middlewares, use wrapMiddlewaresWithSentry() manually. ',\n        );\n      }\n\n      // We didn't wrap any middlewares, so we don't need to import the wrapMiddlewaresWithSentry function\n      if (!needsImport) {\n        return null;\n      }\n\n      transformed = addSentryImport(transformed);\n\n      return { code: transformed, map: null };\n    },\n  };\n}\n\n/**\n * Convert array contents to object shorthand syntax.\n * e.g., \"foo, bar, baz\" â†’ \"{ foo, bar, baz }\"\n *\n * Returns null if contents contain non-identifier expressions (function calls, etc.)\n * which cannot be converted to object shorthand.\n */\nexport function arrayToObjectShorthand(contents: string): string | null {\n  const items = contents\n    .split(',')\n    .map(s => s.trim())\n    .filter(Boolean);\n\n  // Only convert if all items are valid identifiers (no complex expressions)\n  const allIdentifiers = items.every(item => /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(item));\n  if (!allIdentifiers || items.length === 0) {\n    return null;\n  }\n\n  // Deduplicate to avoid invalid syntax like { foo, foo }\n  const uniqueItems = [...new Set(items)];\n\n  return `{ ${uniqueItems.join(', ')} }`;\n}\n\n/**\n * Adds the wrapMiddlewaresWithSentry import to the code.\n * Handles 'use client' and 'use server' directives by inserting the import after them.\n */\nexport function addSentryImport(code: string): string {\n  const sentryImport = \"import { wrapMiddlewaresWithSentry } from '@sentry/tanstackstart-react';\\n\";\n\n  // Don't add the import if it already exists\n  if (code.includes(sentryImport.trimEnd())) {\n    return code;\n  }\n\n  // Check for 'use server' or 'use client' directives, these need to be before any imports\n  const directiveMatch = code.match(/^(['\"])use (client|server)\\1;?\\s*\\n?/);\n\n  if (!directiveMatch) {\n    return sentryImport + code;\n  }\n\n  const directive = directiveMatch[0];\n  return directive + sentryImport + code.slice(directive.length);\n}\n"],"names":[],"mappings":"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"}