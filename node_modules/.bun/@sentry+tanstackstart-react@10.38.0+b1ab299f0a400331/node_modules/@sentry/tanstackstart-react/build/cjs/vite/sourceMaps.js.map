{"version":3,"file":"sourceMaps.js","sources":["../../../src/vite/sourceMaps.ts"],"sourcesContent":["import type { BuildTimeOptionsBase } from '@sentry/core';\nimport { sentryVitePlugin } from '@sentry/vite-plugin';\nimport type { Plugin, UserConfig } from 'vite';\n\ntype FilesToDeleteAfterUpload = string | string[] | undefined;\n\n/**\n * A Sentry plugin for adding the @sentry/vite-plugin to automatically upload source maps to Sentry.\n */\nexport function makeAddSentryVitePlugin(options: BuildTimeOptionsBase): Plugin[] {\n  const {\n    authToken,\n    bundleSizeOptimizations,\n    debug,\n    errorHandler,\n    headers,\n    org,\n    project,\n    release,\n    sentryUrl,\n    silent,\n    sourcemaps,\n    telemetry,\n  } = options;\n\n  // defer resolving the filesToDeleteAfterUpload until we got access to the Vite config\n  let resolveFilesToDeleteAfterUpload: ((value: FilesToDeleteAfterUpload) => void) | undefined;\n  const filesToDeleteAfterUploadPromise = new Promise<FilesToDeleteAfterUpload>(resolve => {\n    resolveFilesToDeleteAfterUpload = resolve;\n  });\n\n  const configPlugin: Plugin = {\n    name: 'sentry-tanstackstart-files-to-delete-after-upload-plugin',\n    apply: 'build',\n    enforce: 'post',\n    config(config) {\n      const userFilesToDelete = sourcemaps?.filesToDeleteAfterUpload;\n\n      // Only auto-delete source maps if the user didn't configure sourcemaps at all\n      if (typeof userFilesToDelete === 'undefined' && typeof config.build?.sourcemap === 'undefined') {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.log(\n            '[Sentry] Automatically setting `sourcemaps.filesToDeleteAfterUpload: [\"./**/*.map\"]` to delete generated source maps after they were uploaded to Sentry.',\n          );\n        }\n        resolveFilesToDeleteAfterUpload?.(['./**/*.map']);\n      } else {\n        resolveFilesToDeleteAfterUpload?.(userFilesToDelete);\n      }\n    },\n  };\n\n  const sentryPlugins = sentryVitePlugin({\n    authToken: authToken ?? process.env.SENTRY_AUTH_TOKEN,\n    bundleSizeOptimizations: bundleSizeOptimizations ?? undefined,\n    debug: debug ?? false,\n    errorHandler,\n    headers,\n    org: org ?? process.env.SENTRY_ORG,\n    project: project ?? process.env.SENTRY_PROJECT,\n    release,\n    silent,\n    sourcemaps: {\n      assets: sourcemaps?.assets,\n      disable: sourcemaps?.disable,\n      ignore: sourcemaps?.ignore,\n      filesToDeleteAfterUpload: filesToDeleteAfterUploadPromise,\n    },\n    telemetry: telemetry ?? true,\n    url: sentryUrl,\n    _metaOptions: {\n      telemetry: {\n        metaFramework: 'tanstackstart-react',\n      },\n    },\n  });\n\n  return [configPlugin, ...sentryPlugins];\n}\n\n/**\n * A Sentry plugin for TanStack Start React to enable \"hidden\" source maps if they are unset.\n */\nexport function makeEnableSourceMapsVitePlugin(options: BuildTimeOptionsBase): Plugin[] {\n  return [\n    {\n      name: 'sentry-tanstackstart-react-source-maps',\n      apply: 'build',\n      enforce: 'post',\n      config(viteConfig) {\n        return {\n          ...viteConfig,\n          build: {\n            ...viteConfig.build,\n            sourcemap: getUpdatedSourceMapSettings(viteConfig, options),\n          },\n        };\n      },\n    },\n  ];\n}\n\n/** There are 3 ways to set up source map generation (https://github.com/getsentry/sentry-javascript/issues/13993)\n *\n *     1. User explicitly disabled source maps\n *       - keep this setting (emit a warning that errors won't be unminified in Sentry)\n *       - We won't upload anything\n *\n *     2. Users enabled source map generation (true, 'hidden', 'inline').\n *       - keep this setting (don't do anything - like deletion - besides uploading)\n *\n *     3. Users didn't set source maps generation\n *       - we enable 'hidden' source maps generation\n *       - configure `filesToDeleteAfterUpload` to delete all .map files (we emit a log about this)\n *\n * --> only exported for testing\n */\nexport function getUpdatedSourceMapSettings(\n  viteConfig: UserConfig,\n  sentryPluginOptions?: BuildTimeOptionsBase,\n): boolean | 'inline' | 'hidden' {\n  viteConfig.build = viteConfig.build || {};\n\n  const viteUserSourceMapSetting = viteConfig.build?.sourcemap;\n  const settingKey = 'vite.build.sourcemap';\n  const debug = sentryPluginOptions?.debug;\n\n  // Respect user source map setting if it is explicitly set\n  if (viteUserSourceMapSetting === false) {\n    if (debug) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `[Sentry] Source map generation is currently disabled in your TanStack Start configuration (\\`${settingKey}: false\\`). Sentry won't override this setting. Without source maps, code snippets on the Sentry Issues page will remain minified.`,\n      );\n    } else {\n      // eslint-disable-next-line no-console\n      console.warn('[Sentry] Source map generation is disabled in your TanStack Start configuration.');\n    }\n\n    return viteUserSourceMapSetting;\n  } else if (viteUserSourceMapSetting && ['hidden', 'inline', true].includes(viteUserSourceMapSetting)) {\n    if (debug) {\n      // eslint-disable-next-line no-console\n      console.log(\n        `[Sentry] We discovered \\`${settingKey}\\` is set to \\`${viteUserSourceMapSetting.toString()}\\`. Sentry will keep this source map setting.`,\n      );\n    }\n\n    return viteUserSourceMapSetting;\n  }\n\n  // If the user did not specify a source map setting, we enable 'hidden' by default\n  if (debug) {\n    // eslint-disable-next-line no-console\n    console.log(\n      `[Sentry] Enabled source map generation in the build options with \\`${settingKey}: 'hidden'\\`. The source maps will be deleted after they were uploaded to Sentry.`,\n    );\n  }\n\n  return 'hidden';\n}\n"],"names":["sentryVitePlugin"],"mappings":"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"}