{"version":3,"file":"wrapFetchWithSentry.js","sources":["../../../src/server/wrapFetchWithSentry.ts"],"sourcesContent":["import { SEMANTIC_ATTRIBUTE_SENTRY_OP, SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, startSpan } from '@sentry/node';\nimport { extractServerFunctionSha256 } from './utils';\n\nexport type ServerEntry = {\n  fetch: (request: Request, opts?: unknown) => Promise<Response> | Response;\n};\n\n/**\n * This function can be used to wrap the server entry request handler to add tracing to server-side functionality.\n * You must explicitly define a server entry point in your application for this to work. This is done by passing the request handler to the `createServerEntry` function.\n * For more information about the server entry point, see the [TanStack Start documentation](https://tanstack.com/start/docs/server-entry).\n *\n * @example\n * ```ts\n * import { wrapFetchWithSentry } from '@sentry/tanstackstart-react';\n *\n * import handler, { createServerEntry } from '@tanstack/react-start/server-entry';\n * import type { ServerEntry } from '@tanstack/react-start/server-entry';\n *\n * const requestHandler: ServerEntry = wrapFetchWithSentry({\n *  fetch(request: Request) {\n *    return handler.fetch(request);\n *  },\n * });\n *\n * export default serverEntry = createServerEntry(requestHandler);\n * ```\n *\n * @param serverEntry - request handler to wrap\n * @returns - wrapped request handler\n */\nexport function wrapFetchWithSentry(serverEntry: ServerEntry): ServerEntry {\n  if (serverEntry.fetch) {\n    serverEntry.fetch = new Proxy<typeof serverEntry.fetch>(serverEntry.fetch, {\n      apply: (target, thisArg, args) => {\n        const request: Request = args[0];\n        const url = new URL(request.url);\n        const method = request.method || 'GET';\n\n        // instrument server functions\n        if (url.pathname.includes('_serverFn') || url.pathname.includes('createServerFn')) {\n          const functionSha256 = extractServerFunctionSha256(url.pathname);\n          const op = 'function.tanstackstart';\n\n          const serverFunctionSpanAttributes = {\n            [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.function.tanstackstart.server',\n            [SEMANTIC_ATTRIBUTE_SENTRY_OP]: op,\n            'tanstackstart.function.hash.sha256': functionSha256,\n          };\n\n          return startSpan(\n            {\n              op: op,\n              name: `${method} ${url.pathname}`,\n              attributes: serverFunctionSpanAttributes,\n            },\n            () => {\n              return target.apply(thisArg, args);\n            },\n          );\n        }\n\n        return target.apply(thisArg, args);\n      },\n    });\n  }\n  return serverEntry;\n}\n"],"names":["extractServerFunctionSha256","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","SEMANTIC_ATTRIBUTE_SENTRY_OP","startSpan"],"mappings":";;;;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,mBAAmB,CAAC,WAAW,EAA4B;AAC3E,EAAE,IAAI,WAAW,CAAC,KAAK,EAAE;AACzB,IAAI,WAAW,CAAC,KAAA,GAAQ,IAAI,KAAK,CAA2B,WAAW,CAAC,KAAK,EAAE;AAC/E,MAAM,KAAK,EAAE,CAAC,MAAM,EAAE,OAAO,EAAE,IAAI,KAAK;AACxC,QAAQ,MAAM,OAAO,GAAY,IAAI,CAAC,CAAC,CAAC;AACxC,QAAQ,MAAM,MAAM,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC;AACxC,QAAQ,MAAM,MAAA,GAAS,OAAO,CAAC,MAAA,IAAU,KAAK;;AAE9C;AACA,QAAQ,IAAI,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,WAAW,KAAK,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,gBAAgB,CAAC,EAAE;AAC3F,UAAU,MAAM,iBAAiBA,iCAA2B,CAAC,GAAG,CAAC,QAAQ,CAAC;AAC1E,UAAU,MAAM,EAAA,GAAK,wBAAwB;;AAE7C,UAAU,MAAM,+BAA+B;AAC/C,YAAY,CAACC,qCAAgC,GAAG,oCAAoC;AACpF,YAAY,CAACC,iCAA4B,GAAG,EAAE;AAC9C,YAAY,oCAAoC,EAAE,cAAc;AAChE,WAAW;;AAEX,UAAU,OAAOC,cAAS;AAC1B,YAAY;AACZ,cAAc,EAAE,EAAE,EAAE;AACpB,cAAc,IAAI,EAAE,CAAC,EAAA,MAAA,CAAA,CAAA,EAAA,GAAA,CAAA,QAAA,CAAA,CAAA;AACA,cAAA,UAAA,EAAA,4BAAA;AACA,aAAA;AACA,YAAA,MAAA;AACA,cAAA,OAAA,MAAA,CAAA,KAAA,CAAA,OAAA,EAAA,IAAA,CAAA;AACA,YAAA,CAAA;AACA,WAAA;AACA,QAAA;;AAEA,QAAA,OAAA,MAAA,CAAA,KAAA,CAAA,OAAA,EAAA,IAAA,CAAA;AACA,MAAA,CAAA;AACA,KAAA,CAAA;AACA,EAAA;AACA,EAAA,OAAA,WAAA;AACA;;;;"}